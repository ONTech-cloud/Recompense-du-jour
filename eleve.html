<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>√âl√®ve - Question du jour</title>
<style>
  body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    background:linear-gradient(120deg,#e0f7ff,#cceeff);
    display:flex;flex-direction:column;align-items:center;min-height:100vh;margin:0;padding:40px 16px 24px;
  }
  h1{color:#0077cc;font-size:2em;margin:0 0 24px}
  #selection{display:flex;gap:32px;margin-bottom:32px;flex-wrap:wrap;justify-content:center}
  .profil-btn{
    padding:36px 72px;font-size:1.5em;border-radius:32px;border:none;cursor:pointer;
    background:linear-gradient(135deg,#6CC1FF,#3A8DFF);color:#fff;
    transition:transform .25s,box-shadow .25s;
  }
  .profil-btn:hover{transform:scale(1.08);box-shadow:0 0 24px rgba(0,0,0,.25)}

  .question-box{
    display:none;flex-direction:column;align-items:center;background:#fff;padding:24px;border-radius:28px;
    width:100%;max-width:640px;box-shadow:0 10px 25px rgba(0,0,0,.15);animation:fadeIn .45s ease;
  }
  @keyframes fadeIn{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}
  #questionText{font-size:1.35em;color:#005fa3;margin-bottom:16px;text-align:center}

  .answer-input,.answer-select{
    width:100%;padding:14px 16px;font-size:1.15em;border-radius:18px;border:2px solid #3A8DFF;outline:none;margin-top:10px;
    transition:border .25s,box-shadow .25s;background:#fff;
  }
  .answer-input:focus,.answer-select:focus{border-color:#0077cc;box-shadow:0 0 12px rgba(0,123,255,.25)}

  .mini-btns{display:flex;gap:14px;justify-content:center;margin-top:10px;width:100%}
  .mini-btn{
    flex:1;padding:14px 10px;border-radius:18px;border:2px solid #3A8DFF;background:#fff;cursor:pointer;font-size:1.1em;
    transition:all .25s;
  }
  .mini-btn.selected{background:#3A8DFF;color:#fff}

  .answer-btn{
    margin-top:18px;padding:14px;width:100%;font-size:1.15em;border-radius:22px;border:none;background:#0077cc;color:#fff;
    cursor:pointer;transition:transform .2s,box-shadow .2s;
  }
  .answer-btn:hover{transform:scale(1.03);box-shadow:0 0 18px rgba(0,0,0,.25)}

  /* Roulette */
  #rouletteWrap{margin-top:26px;display:flex;flex-direction:column;align-items:center;gap:10px}
  #roulette{
    width:230px;height:230px;border:8px solid #0077cc;border-radius:50%;display:flex;align-items:center;justify-content:center;
    position:relative;overflow:hidden;background:#f8fbff;
  }
  #roulette.spinning{animation:spin .6s linear infinite}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  #roulette span{
    position:absolute;width:100%;text-align:center;font-weight:700;color:#0077cc;font-size:1.1em;padding:0 12px;
    transition:transform .4s;
  }
  #pointer{
    width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:18px solid #ff3366;
    margin-top:-6px;
  }

  #log{margin-top:12px;color:#d00;font-weight:600;text-align:center}
</style>
</head>
<body>

<h1>Choisis ton profil</h1>
<div id="selection">
  <button id="amirBtn" class="profil-btn">Amir</button>
  <button id="youssefBtn" class="profil-btn">Youssef</button>
</div>

<div id="questionSection" class="question-box">
  <div id="questionText"></div>

  <!-- phrase -->
  <input type="text" id="answerInput" class="answer-input" placeholder="Ta r√©ponse ici" style="display:none;"/>

  <!-- nombre -->
  <select id="answerSelect" class="answer-select" style="display:none;"></select>

  <!-- oui/non -->
  <div id="miniBtns" class="mini-btns" style="display:none;">
    <button class="mini-btn" data-value="oui">Oui</button>
    <button class="mini-btn" data-value="non">Non</button>
  </div>

  <button class="answer-btn" id="submitBtn">Valider</button>

  <div id="rouletteWrap">
    <div id="pointer"></div>
    <div id="roulette"><span>üéÅ</span></div>
  </div>
</div>

<div id="log"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyAUzLQK-ueXOslGncKrmqAXpwFtisMdyGI",
  authDomain: "recompense-du-jour.firebaseapp.com",
  projectId: "recompense-du-jour",
  storageBucket: "recompense-du-jour.appspot.com",
  messagingSenderId: "67482964719",
  appId: "1:67482964719:web:0c735a559493b1d4ae011a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let eleve = null;
let currentQuestion = null;
let surprisesList = [];

// S√©lection du profil
document.getElementById("amirBtn").addEventListener("click", () => selectProfile("Amir"));
document.getElementById("youssefBtn").addEventListener("click", () => selectProfile("Youssef"));

async function selectProfile(profil){
  eleve = profil;
  sessionStorage.setItem("eleve", profil);
  document.getElementById("selection").style.display = "none";
  await loadQuestion();
  await loadSurprises();
}

// Charge la question depuis Firestore
async function loadQuestion(){
  try{
    const snap = await getDoc(doc(db, "questions", eleve));
    if(!snap.exists()){
      setLog("‚ö†Ô∏è Aucune question pour " + eleve);
      return;
    }
    const data = snap.data();
    currentQuestion = {
      titre: data.titre || data.question || "Question du jour",
      texte: data.texte || data.question || "",
      type: normalizeType(data.type),
      bonneReponse: (data.bonneReponse ?? (Array.isArray(data.answers)?data.answers[0]:undefined) ?? data.reponse ?? data.solution ?? "").toString(),
      options: Array.isArray(data.answers) ? data.answers.map(x=>x.toString()) : null
    };
    showQuestion();
  }catch(e){
    console.error(e);
    setLog("Erreur Firebase (question) : " + e.message);
  }
}

function normalizeType(t){
  if(!t) return "phrase";
  const s = t.toString().toLowerCase();
  if(s==="oui_non" || s==="ouinon" || s==="oui/non") return "oui_non";
  if(s==="nombre" || s==="number") return "nombre";
  return "phrase";
}

// Charge surprises
async function loadSurprises(){
  surprisesList = [];
  try{
    const sub = await getDocs(collection(db, "surprises", eleve, "liste"));
    sub.forEach(d=>{
      const v = d.data();
      const name = v?.nom ?? v?.name ?? v?.titre ?? (typeof v==="string"?v:undefined);
      if(name) surprisesList.push(name.toString());
    });
    if(surprisesList.length>0) return;

    const docSnap = await getDoc(doc(db, "surprises", eleve));
    if(docSnap.exists()){
      const v = docSnap.data();
      const arr = Array.isArray(v?.liste)?v.liste : (Array.isArray(v?.items)?v.items : (Array.isArray(v?.surprises)?v.surprises : null));
      if(arr && arr.length){
        surprisesList = arr.map(x=> (typeof x==="string")?x : (x?.nom ?? x?.name ?? x?.titre ?? "") ).filter(Boolean).map(String);
        return;
      }
    }

    const top = await getDocs(collection(db,"surprises"));
    const picked = [];
    top.forEach(d=>{
      const v = d.data();
      if(v?.eleve === eleve || d.id === eleve || d.id.startsWith(eleve+"_")){
        const name = v?.nom ?? v?.name ?? v?.titre;
        if(name) picked.push(name.toString());
        if(Array.isArray(v?.liste)) v.liste.forEach(x=>picked.push(String(x)));
      }
    });
    if(picked.length){ surprisesList = picked; return; }

    top.forEach(d=>{ const v=d.data(); const name = v?.nom ?? v?.name ?? v?.titre; if(name) surprisesList.push(name.toString()); });
  }catch(e){
    console.error("Erreur chargement surprises:", e);
    setLog("Erreur Firebase (surprises) : " + e.message);
  }
}

// Affiche la question
function showQuestion(){
  document.getElementById("questionSection").style.display = "flex";
  document.getElementById("questionText").innerHTML =
    `<strong>${escapeHtml(currentQuestion.titre)}</strong><br>${escapeHtml(currentQuestion.texte)}`;

  // reset vues
  const inp = document.getElementById("answerInput");
  const sel = document.getElementById("answerSelect");
  const yn  = document.getElementById("miniBtns");
  inp.style.display="none"; sel.style.display="none"; yn.style.display="none";
  inp.value=""; sel.innerHTML="";

  if(currentQuestion.type==="oui_non"){
    yn.style.display="flex";
    document.querySelectorAll(".mini-btn").forEach(b=>b.classList.remove("selected"));

  }else if(currentQuestion.type==="nombre"){
    sel.style.display="block";

    // Menu d√©roulant toujours 0 ‚Üí 100
    const values = Array.from({length:101},(_,i)=> i.toString());

    sel.innerHTML = values.map(v => 
      `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`
    ).join("");
  } 
  else {
    // phrase libre
    inp.style.display="block";
  }
}

// Oui/Non s√©lection
document.querySelectorAll(".mini-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".mini-btn").forEach(b=>b.classList.remove("selected"));
    btn.classList.add("selected");
  });
});

// Validation
document.getElementById("submitBtn").addEventListener("click", ()=>{
  if(!currentQuestion){ setLog("Pas de question charg√©e."); return; }

  let answer="";
  if(currentQuestion.type==="oui_non"){
    const sel = document.querySelector(".mini-btn.selected");
    if(!sel){ alert("Choisis Oui ou Non"); return; }
    answer = sel.dataset.value;
  }else if(currentQuestion.type==="nombre"){
    answer = document.getElementById("answerSelect").value;
  }else{
    answer = document.getElementById("answerInput").value.trim();
  }

  const a = String(answer).trim().toLowerCase();
  const b = String(currentQuestion.bonneReponse ?? "").trim().toLowerCase();
  if(!a){ alert("Merci de r√©pondre !"); return; }

  if(a===b){ startRoulette(); }
  else{ alert("‚ùå Mauvaise r√©ponse, essaie encore !"); }
});

// Roulette
function startRoulette(){
  const wrap = document.getElementById("roulette");
  if(!surprisesList || surprisesList.length===0){
    wrap.classList.remove("spinning");
    wrap.innerHTML = `<span>Aucune surprise disponible</span>`;
    return;
  }

  let i=0;
  wrap.classList.add("spinning");
  const tick = setInterval(()=>{
    wrap.innerHTML = `<span>${escapeHtml(surprisesList[i % surprisesList.length])}</span>`;
    i++;
  },140);

  const duration = 2600 + Math.floor(Math.random()*800);
  setTimeout(()=>{
    clearInterval(tick);
    wrap.classList.remove("spinning");
    const final = surprisesList[Math.floor(Math.random()*surprisesList.length)];
    wrap.innerHTML = `<span>üéÅ : ${escapeHtml(final)}</span>`;
  }, duration);
}

function setLog(msg){ document.getElementById("log").textContent = msg; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
</script>
</body>
</html>
